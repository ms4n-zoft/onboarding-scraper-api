<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Product Scraper - Async Demo</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Oxygen, Ubuntu, Cantarell, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 900px;
        margin: 0 auto;
      }

      .header {
        text-align: center;
        color: white;
        margin-bottom: 30px;
      }

      .header h1 {
        font-size: 2.5rem;
        margin-bottom: 10px;
      }

      .header p {
        font-size: 1.1rem;
        opacity: 0.9;
      }

      .badge {
        display: inline-block;
        padding: 4px 12px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 12px;
        font-size: 0.85rem;
        margin-top: 8px;
      }

      .job-info {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 16px;
        font-size: 0.9rem;
      }

      .job-info-item {
        display: flex;
        justify-content: space-between;
        padding: 4px 0;
      }

      .job-info-label {
        font-weight: 600;
        color: #666;
      }

      .job-info-value {
        color: #333;
        font-family: "Courier New", monospace;
      }

      .resume-banner {
        background: #fff3cd;
        border-left: 4px solid #ffc107;
        padding: 16px;
        border-radius: 8px;
        margin-bottom: 20px;
        display: none;
      }

      .resume-banner.active {
        display: block;
      }

      .resume-banner-title {
        font-weight: 600;
        color: #856404;
        margin-bottom: 8px;
      }

      .resume-banner-actions {
        display: flex;
        gap: 12px;
        margin-top: 12px;
      }

      .btn-small {
        padding: 8px 16px;
        background: #667eea;
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 0.9rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
      }

      .btn-small:hover {
        background: #5568d3;
      }

      .btn-small.secondary {
        background: #6c757d;
      }

      .btn-small.secondary:hover {
        background: #5a6268;
      }

      .card {
        background: white;
        border-radius: 12px;
        padding: 30px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        margin-bottom: 20px;
      }

      .input-group {
        margin-bottom: 20px;
      }

      .input-group label {
        display: block;
        font-weight: 600;
        margin-bottom: 8px;
        color: #333;
      }

      .input-group input {
        width: 100%;
        padding: 12px 16px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 1rem;
        transition: border-color 0.3s;
      }

      .input-group input:focus {
        outline: none;
        border-color: #667eea;
      }

      .btn {
        width: 100%;
        padding: 14px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
      }

      .btn:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
      }

      .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .btn-group {
        display: flex;
        gap: 12px;
      }

      .btn-secondary {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      }

      .btn-secondary:hover:not(:disabled) {
        box-shadow: 0 5px 15px rgba(245, 87, 108, 0.4);
      }

      .status-section {
        display: none;
      }

      .status-section.active {
        display: block;
      }

      .status-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 20px;
      }

      .spinner {
        width: 24px;
        height: 24px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .status-header h3 {
        color: #333;
        font-size: 1.2rem;
      }

      .events-list {
        max-height: 400px;
        overflow-y: auto;
        background: #f8f9fa;
        border-radius: 8px;
        padding: 16px;
      }

      .event-item {
        padding: 12px 16px;
        margin-bottom: 10px;
        border-radius: 6px;
        animation: slideIn 0.3s ease-out;
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateX(-20px);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }

      .event-item.start {
        background: #e3f2fd;
        border-left: 4px solid #2196f3;
      }

      .event-item.reading {
        background: #fff3e0;
        border-left: 4px solid #ff9800;
      }

      .event-item.update {
        background: #f3e5f5;
        border-left: 4px solid #9c27b0;
      }

      .event-item.complete {
        background: #e8f5e9;
        border-left: 4px solid #4caf50;
        font-weight: 600;
      }

      .event-item.error {
        background: #ffebee;
        border-left: 4px solid #f44336;
      }

      .event-time {
        font-size: 0.75rem;
        color: #666;
        margin-bottom: 4px;
      }

      .event-message {
        color: #333;
        font-size: 0.95rem;
      }

      .event-url {
        font-family: "Courier New", monospace;
        font-size: 0.85rem;
        color: #667eea;
        margin-top: 4px;
        word-break: break-all;
      }

      .result-section {
        display: none;
      }

      .result-section.active {
        display: block;
      }

      .tabs {
        display: flex;
        gap: 8px;
        margin-bottom: 20px;
        border-bottom: 2px solid #e0e0e0;
      }

      .tab {
        padding: 12px 24px;
        background: transparent;
        border: none;
        border-bottom: 3px solid transparent;
        cursor: pointer;
        font-size: 1rem;
        font-weight: 600;
        color: #666;
        transition: all 0.3s;
      }

      .tab:hover {
        color: #667eea;
      }

      .tab.active {
        color: #667eea;
        border-bottom-color: #667eea;
      }

      .tab-content {
        display: none;
      }

      .tab-content.active {
        display: block;
      }

      .view-toggle {
        display: flex;
        gap: 8px;
        margin-bottom: 16px;
        padding: 4px;
        background: #e9ecef;
        border-radius: 8px;
        width: fit-content;
      }

      .toggle-btn {
        padding: 8px 16px;
        background: transparent;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.9rem;
        font-weight: 600;
        color: #666;
        transition: all 0.2s;
      }

      .toggle-btn:hover {
        color: #333;
      }

      .toggle-btn.active {
        background: white;
        color: #667eea;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .result-content {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 16px;
        max-height: 500px;
        overflow-y: auto;
      }

      .result-content pre {
        margin: 0;
        white-space: pre-wrap;
        word-wrap: break-word;
        font-family: "Courier New", monospace;
        font-size: 0.9rem;
        line-height: 1.5;
      }

      .events-trail {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 16px;
        max-height: 500px;
        overflow-y: auto;
      }

      .error-message {
        background: #ffebee;
        color: #c62828;
        padding: 16px;
        border-radius: 8px;
        border-left: 4px solid #f44336;
        margin-top: 16px;
      }

      /* Rendered View Styles */
      .product-view {
        background: white;
        border-radius: 8px;
        padding: 0;
      }

      .product-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 24px;
        border-radius: 8px 8px 0 0;
      }

      .product-header h2 {
        font-size: 1.8rem;
        margin-bottom: 8px;
      }

      .product-header .company {
        font-size: 1.1rem;
        opacity: 0.9;
        margin-bottom: 4px;
      }

      .product-header .website-link {
        color: white;
        opacity: 0.8;
        text-decoration: none;
        font-size: 0.9rem;
      }

      .product-header .website-link:hover {
        opacity: 1;
        text-decoration: underline;
      }

      .product-section {
        padding: 20px 24px;
        border-bottom: 1px solid #e0e0e0;
      }

      .product-section:last-child {
        border-bottom: none;
      }

      .product-section h3 {
        color: #667eea;
        font-size: 1.2rem;
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .product-section h4 {
        color: #333;
        font-size: 1rem;
        margin-top: 16px;
        margin-bottom: 8px;
      }

      .product-section p {
        color: #555;
        line-height: 1.6;
        margin-bottom: 12px;
      }

      .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 12px;
        margin-bottom: 12px;
      }

      .info-item {
        background: #f8f9fa;
        padding: 12px;
        border-radius: 6px;
      }

      .info-label {
        font-weight: 600;
        color: #666;
        font-size: 0.85rem;
        margin-bottom: 4px;
      }

      .info-value {
        color: #333;
        font-size: 0.95rem;
      }

      .tag-list {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }

      .tag {
        background: #e3f2fd;
        color: #1976d2;
        padding: 6px 12px;
        border-radius: 16px;
        font-size: 0.85rem;
        font-weight: 500;
      }

      .feature-list {
        display: grid;
        gap: 8px;
      }

      .feature-item {
        background: #f8f9fa;
        padding: 12px;
        border-radius: 6px;
        border-left: 3px solid #667eea;
      }

      .feature-name {
        font-weight: 600;
        color: #333;
        margin-bottom: 4px;
      }

      .feature-desc {
        color: #666;
        font-size: 0.9rem;
      }

      .pricing-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 16px;
      }

      .pricing-card {
        background: white;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        padding: 20px;
        transition: all 0.3s;
      }

      .pricing-card:hover {
        border-color: #667eea;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
      }

      .pricing-card.free {
        border-color: #4caf50;
      }

      .plan-name {
        font-size: 1.3rem;
        font-weight: 700;
        color: #333;
        margin-bottom: 8px;
      }

      .plan-price {
        font-size: 1.8rem;
        font-weight: 700;
        color: #667eea;
        margin-bottom: 4px;
      }

      .plan-period {
        color: #666;
        font-size: 0.9rem;
        margin-bottom: 16px;
      }

      .plan-features {
        list-style: none;
      }

      .plan-features li {
        padding: 6px 0;
        color: #555;
        font-size: 0.9rem;
      }

      .plan-features li:before {
        content: "‚úì ";
        color: #4caf50;
        font-weight: bold;
        margin-right: 8px;
      }

      .review-summary {
        background: #f8f9fa;
        padding: 16px;
        border-radius: 8px;
      }

      .rating {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 12px;
      }

      .rating-value {
        font-size: 2rem;
        font-weight: 700;
        color: #667eea;
      }

      .rating-stars {
        font-size: 1.5rem;
        color: #ffc107;
      }

      .review-list {
        margin-top: 12px;
      }

      .review-list h5 {
        color: #333;
        font-size: 1rem;
        margin-bottom: 8px;
      }

      .review-list ul {
        list-style-position: inside;
        color: #555;
      }

      .review-list li {
        padding: 4px 0;
      }

      .social-links {
        display: flex;
        gap: 12px;
      }

      .social-link {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 8px 16px;
        background: #f8f9fa;
        border-radius: 6px;
        color: #667eea;
        text-decoration: none;
        font-size: 0.9rem;
        font-weight: 500;
        transition: all 0.2s;
      }

      .social-link:hover {
        background: #667eea;
        color: white;
      }

      .integration-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        gap: 12px;
      }

      .integration-item {
        background: #f8f9fa;
        padding: 12px;
        border-radius: 6px;
        text-align: center;
      }

      .integration-name {
        font-weight: 600;
        color: #333;
        font-size: 0.9rem;
      }

      .empty-state {
        color: #999;
        font-style: italic;
        padding: 12px;
        text-align: center;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>Product Scraper Engine</h1>
        <p>Async job processing with reconnection support</p>
        <div class="badge">
          ‚úì Resume on refresh | ‚úì 24hr persistence | ‚úì Event replay
        </div>
      </div>

      <div class="card resume-banner" id="resumeBanner">
        <div class="resume-banner-title">üìã Found existing job in progress</div>
        <div class="job-info">
          <div class="job-info-item">
            <span class="job-info-label">Job ID:</span>
            <span class="job-info-value" id="resumeJobId">-</span>
          </div>
          <div class="job-info-item">
            <span class="job-info-label">URL:</span>
            <span class="job-info-value" id="resumeJobUrl">-</span>
          </div>
          <div class="job-info-item">
            <span class="job-info-label">Started:</span>
            <span class="job-info-value" id="resumeJobTime">-</span>
          </div>
        </div>
        <div class="resume-banner-actions">
          <button class="btn-small" onclick="resumeJob()">Resume Job</button>
          <button class="btn-small secondary" onclick="clearJob()">
            Start New Job
          </button>
        </div>
      </div>

      <div class="card">
        <div class="input-group">
          <label for="urlInput">Product URL</label>
          <input
            type="url"
            id="urlInput"
            placeholder="https://example.com/product"
            value="https://www.intercom.com"
          />
        </div>
        <div class="btn-group">
          <button
            class="btn"
            id="scrapeBtn"
            onclick="startScraping()"
            style="flex: 1"
          >
            Start Async Job
          </button>
          <button
            class="btn btn-secondary"
            id="scrapeStreamBtn"
            onclick="startScrapingSSE()"
            style="flex: 1"
          >
            Start SSE Stream
          </button>
        </div>
      </div>

      <div class="card status-section" id="statusSection">
        <div class="job-info" id="jobInfo" style="display: none">
          <div class="job-info-item">
            <span class="job-info-label">Job ID:</span>
            <span class="job-info-value" id="currentJobId">-</span>
          </div>
          <div class="job-info-item">
            <span class="job-info-label">Status:</span>
            <span class="job-info-value" id="currentJobStatus">-</span>
          </div>
        </div>
        <div class="status-header">
          <div class="spinner"></div>
          <h3>Scraping in progress...</h3>
        </div>
        <div class="events-list" id="eventsList"></div>
      </div>

      <div class="card result-section" id="resultSection">
        <div class="tabs">
          <button class="tab active" onclick="switchTab('result')">
            Result
          </button>
          <button class="tab" onclick="switchTab('events')">Event Trail</button>
        </div>
        <div class="tab-content active" id="resultTab">
          <div class="view-toggle">
            <button class="toggle-btn active" onclick="toggleView('rendered')">
              üìä Rendered View
            </button>
            <button class="toggle-btn" onclick="toggleView('raw')">
              üìù Raw JSON
            </button>
          </div>
          <div class="result-content" id="renderedView"></div>
          <div class="result-content" id="rawView" style="display: none">
            <pre id="resultContent"></pre>
          </div>
        </div>
        <div class="tab-content" id="eventsTab">
          <div class="events-trail" id="eventsTrail"></div>
        </div>
      </div>
    </div>

    <script>
      let eventSource = null;
      let currentJobId = null;
      let currentResultData = null;

      // Check for existing job on page load
      window.addEventListener("DOMContentLoaded", function () {
        checkForExistingJob();
      });

      function toggleView(viewType) {
        const renderedView = document.getElementById("renderedView");
        const rawView = document.getElementById("rawView");
        const toggleBtns = document.querySelectorAll(".toggle-btn");

        toggleBtns.forEach((btn) => btn.classList.remove("active"));

        if (viewType === "rendered") {
          renderedView.style.display = "block";
          rawView.style.display = "none";
          document
            .querySelector('.toggle-btn[onclick*="rendered"]')
            .classList.add("active");
        } else {
          renderedView.style.display = "none";
          rawView.style.display = "block";
          document
            .querySelector('.toggle-btn[onclick*="raw"]')
            .classList.add("active");
        }
      }

      function renderProductView(data) {
        const container = document.getElementById("renderedView");

        if (!data) {
          container.innerHTML =
            '<div class="empty-state">No data available</div>';
          return;
        }

        let html = '<div class="product-view">';

        // Header Section
        html += '<div class="product-header">';
        if (data.product_name) {
          html += `<h2>${escapeHtml(data.product_name)}</h2>`;
        }
        if (data.company_name) {
          html += `<div class="company">${escapeHtml(data.company_name)}</div>`;
        }
        if (data.website) {
          html += `<a href="${escapeHtml(
            data.website
          )}" target="_blank" class="website-link">üåê ${escapeHtml(
            data.website
          )}</a>`;
        }
        html += "</div>";

        // Short Description
        if (data.short_description) {
          html += '<div class="product-section">';
          html += "<h3>üìù Overview</h3>";
          html += `<p>${escapeHtml(data.short_description)}</p>`;
          html += "</div>";
        }

        // Basic Info Grid
        html += '<div class="product-section">';
        html += "<h3>‚ÑπÔ∏è Basic Information</h3>";
        html += '<div class="info-grid">';

        if (data.year_founded) {
          html += `<div class="info-item">
            <div class="info-label">Year Founded</div>
            <div class="info-value">${data.year_founded}</div>
          </div>`;
        }

        if (data.hq_location) {
          html += `<div class="info-item">
            <div class="info-label">Headquarters</div>
            <div class="info-value">${escapeHtml(data.hq_location)}</div>
          </div>`;
        }

        if (data.market_size) {
          html += `<div class="info-item">
            <div class="info-label">Market Size</div>
            <div class="info-value">${escapeHtml(data.market_size)}</div>
          </div>`;
        }

        if (data.parent_category) {
          html += `<div class="info-item">
            <div class="info-label">Category</div>
            <div class="info-value">${escapeHtml(data.parent_category)}</div>
          </div>`;
        }

        html += "</div></div>";

        // Categories and Industries
        if ((data.industry && data.industry.length > 0) || data.sub_category) {
          html += '<div class="product-section">';
          html += "<h3>üè¢ Industries & Categories</h3>";

          if (data.industry && data.industry.length > 0) {
            html += "<h4>Industries</h4>";
            html += '<div class="tag-list">';
            data.industry.forEach((ind) => {
              html += `<span class="tag">${escapeHtml(ind)}</span>`;
            });
            html += "</div>";
          }

          if (data.sub_category) {
            html += "<h4>Sub-category</h4>";
            html += `<p>${escapeHtml(data.sub_category)}</p>`;
          }

          html += "</div>";
        }

        // Elevator Pitch
        if (data.elevator_pitch) {
          html += '<div class="product-section">';
          html += "<h3>üéØ Product Overview</h3>";
          html += `<p>${escapeHtml(data.elevator_pitch)}</p>`;
          html += "</div>";
        }

        // Competitive Advantage
        if (data.competitive_advantage) {
          html += '<div class="product-section">';
          html += "<h3>‚ö° Competitive Advantage</h3>";
          html += `<p>${escapeHtml(data.competitive_advantage)}</p>`;
          html += "</div>";
        }

        // Features
        if (data.features && data.features.length > 0) {
          html += '<div class="product-section">';
          html += "<h3>‚ú® Key Features</h3>";

          if (data.feature_overview) {
            html += `<p>${escapeHtml(data.feature_overview)}</p>`;
          }

          html += '<div class="feature-list">';
          data.features.slice(0, 20).forEach((feature) => {
            html += '<div class="feature-item">';
            html += `<div class="feature-name">${escapeHtml(
              feature.name
            )}</div>`;
            if (feature.description) {
              html += `<div class="feature-desc">${escapeHtml(
                feature.description
              )}</div>`;
            }
            html += "</div>";
          });
          html += "</div></div>";
        }

        // Pricing
        if (
          data.pricing &&
          data.pricing.pricing_plans &&
          data.pricing.pricing_plans.length > 0
        ) {
          html += '<div class="product-section">';
          html += "<h3>üí∞ Pricing</h3>";

          if (data.pricing.overview || data.pricing_overview) {
            html += `<p>${escapeHtml(
              data.pricing.overview || data.pricing_overview
            )}</p>`;
          }

          html += '<div class="pricing-grid">';
          data.pricing.pricing_plans.forEach((plan) => {
            const isFree = plan.is_free || plan.plan.toLowerCase() === "free";
            html += `<div class="pricing-card ${isFree ? "free" : ""}">`;
            html += `<div class="plan-name">${escapeHtml(plan.plan)}</div>`;

            if (plan.amount || plan.is_free) {
              html += '<div class="plan-price">';
              if (isFree) {
                html += "Free";
              } else {
                html += `${plan.currency || "$"}${plan.amount || "Contact"}`;
              }
              html += "</div>";
            }

            if (plan.period) {
              html += `<div class="plan-period">per ${escapeHtml(
                plan.period
              )}</div>`;
            }

            if (plan.description && plan.description.length > 0) {
              html += '<ul class="plan-features">';
              plan.description.forEach((feature) => {
                html += `<li>${escapeHtml(feature)}</li>`;
              });
              html += "</ul>";
            }

            html += "</div>";
          });
          html += "</div></div>";
        }

        // Contact Information
        if (data.contact) {
          html += '<div class="product-section">';
          html += "<h3>üìû Contact Information</h3>";
          html += '<div class="info-grid">';

          if (data.contact.phone_number) {
            html += `<div class="info-item">
              <div class="info-label">Phone</div>
              <div class="info-value">${
                data.contact.country_code || ""
              } ${escapeHtml(data.contact.phone_number)}</div>
            </div>`;
          }

          if (data.contact.support_email) {
            html += `<div class="info-item">
              <div class="info-label">Email</div>
              <div class="info-value">${escapeHtml(
                data.contact.support_email
              )}</div>
            </div>`;
          }

          if (data.contact.address) {
            html += `<div class="info-item">
              <div class="info-label">Address</div>
              <div class="info-value">${escapeHtml(data.contact.address)}</div>
            </div>`;
          }

          html += "</div></div>";
        }

        // Social Links
        if (data.social_profiles) {
          html += '<div class="product-section">';
          html += "<h3>üîó Social Media</h3>";
          html += '<div class="social-links">';

          if (data.social_profiles.linkedin) {
            html += `<a href="${escapeHtml(
              data.social_profiles.linkedin
            )}" target="_blank" class="social-link">LinkedIn</a>`;
          }
          if (data.social_profiles.twitter) {
            html += `<a href="${escapeHtml(
              data.social_profiles.twitter
            )}" target="_blank" class="social-link">Twitter</a>`;
          }
          if (data.social_profiles.facebook) {
            html += `<a href="${escapeHtml(
              data.social_profiles.facebook
            )}" target="_blank" class="social-link">Facebook</a>`;
          }

          html += "</div></div>";
        }

        // Reviews
        if (data.reviews) {
          html += '<div class="product-section">';
          html += "<h3>‚≠ê Reviews</h3>";
          html += '<div class="review-summary">';

          if (data.reviews.overall_rating) {
            html += '<div class="rating">';
            html += `<span class="rating-value">${data.reviews.overall_rating.toFixed(
              1
            )}</span>`;
            html += `<span class="rating-stars">${"‚òÖ".repeat(
              Math.round(data.reviews.overall_rating)
            )}${"‚òÜ".repeat(
              5 - Math.round(data.reviews.overall_rating)
            )}</span>`;
            html += "</div>";
          }

          if (
            data.reviews.review_sources &&
            data.reviews.review_sources.length > 0
          ) {
            html += '<div class="info-label">Sources</div>';
            html += '<div class="tag-list">';
            data.reviews.review_sources.forEach((source) => {
              html += `<span class="tag">${escapeHtml(source)}</span>`;
            });
            html += "</div>";
          }

          html += '<div class="review-list">';

          if (data.reviews.strengths && data.reviews.strengths.length > 0) {
            html += "<h5>Strengths</h5>";
            html += "<ul>";
            data.reviews.strengths.forEach((strength) => {
              html += `<li>${escapeHtml(strength)}</li>`;
            });
            html += "</ul>";
          }

          if (data.reviews.weaknesses && data.reviews.weaknesses.length > 0) {
            html += "<h5>Weaknesses</h5>";
            html += "<ul>";
            data.reviews.weaknesses.forEach((weakness) => {
              html += `<li>${escapeHtml(weakness)}</li>`;
            });
            html += "</ul>";
          }

          html += "</div></div></div>";
        }

        // Company Info
        if (data.company_info) {
          html += '<div class="product-section">';
          html += "<h3>üè≠ Company Information</h3>";

          if (data.company_info.overview) {
            html += "<h4>Overview</h4>";
            html += `<p>${escapeHtml(data.company_info.overview)}</p>`;
          }

          if (data.company_info.founding) {
            html += "<h4>Founding Story</h4>";
            html += `<p>${escapeHtml(data.company_info.founding)}</p>`;
          }

          if (data.company_info.funding_info) {
            html += "<h4>Funding</h4>";
            html += `<p>${escapeHtml(data.company_info.funding_info)}</p>`;
          }

          if (
            data.company_info.product_offerings &&
            data.company_info.product_offerings.length > 0
          ) {
            html += "<h4>Product Offerings</h4>";
            html += '<div class="tag-list">';
            data.company_info.product_offerings.forEach((product) => {
              html += `<span class="tag">${escapeHtml(product)}</span>`;
            });
            html += "</div>";
          }

          html += "</div>";
        }

        // AI Capabilities
        if (data.ai_capabilities || data.ai_info) {
          html += '<div class="product-section">';
          html += "<h3>ü§ñ AI Capabilities</h3>";

          if (data.ai_capabilities) {
            html += `<p>${escapeHtml(data.ai_capabilities)}</p>`;
          }

          if (data.ai_info) {
            if (data.ai_info.ai_usage_summary) {
              html += "<h4>AI Usage</h4>";
              html += `<p>${escapeHtml(data.ai_info.ai_usage_summary)}</p>`;
            }
            if (data.ai_info.ai_technologies_used) {
              html += "<h4>Technologies Used</h4>";
              html += `<p>${escapeHtml(data.ai_info.ai_technologies_used)}</p>`;
            }
          }

          html += "</div>";
        }

        // Integrations
        if (data.integrations && data.integrations.length > 0) {
          html += '<div class="product-section">';
          html += "<h3>üîå Integrations</h3>";
          html += '<div class="integration-grid">';
          data.integrations.slice(0, 12).forEach((integration) => {
            html += '<div class="integration-item">';
            html += `<div class="integration-name">${escapeHtml(
              integration.name
            )}</div>`;
            html += "</div>";
          });
          html += "</div></div>";
        }

        // Languages Supported
        if (data.languages_supported && data.languages_supported.length > 0) {
          html += '<div class="product-section">';
          html += "<h3>üåç Languages Supported</h3>";
          html += '<div class="tag-list">';
          data.languages_supported.forEach((lang) => {
            html += `<span class="tag">${escapeHtml(lang)}</span>`;
          });
          html += "</div></div>";
        }

        // Deployment & Support
        html += '<div class="product-section">';
        html += "<h3>üöÄ Deployment & Support</h3>";
        html += '<div class="info-grid">';

        if (data.deployment_options && data.deployment_options.length > 0) {
          html += '<div class="info-item">';
          html += '<div class="info-label">Deployment Options</div>';
          html += '<div class="info-value">';
          html +=
            data.deployment_options.map((d) => escapeHtml(d.type)).join(", ") ||
            "N/A";
          html += "</div></div>";
        }

        if (data.support_options && data.support_options.length > 0) {
          html += '<div class="info-item">';
          html += '<div class="info-label">Support Channels</div>';
          html += '<div class="info-value">';
          html +=
            data.support_options.map((s) => escapeHtml(s.type)).join(", ") ||
            "N/A";
          html += "</div></div>";
        }

        html += "</div></div>";

        html += "</div>"; // close product-view

        container.innerHTML = html;
      }

      function escapeHtml(text) {
        if (text === null || text === undefined) return "";
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      function checkForExistingJob() {
        const jobId = localStorage.getItem("currentJobId");
        const jobUrl = localStorage.getItem("jobUrl");
        const jobStartTime = localStorage.getItem("jobStartTime");

        if (jobId && jobStartTime) {
          const elapsed = Date.now() - parseInt(jobStartTime);
          const hours = Math.floor(elapsed / (1000 * 60 * 60));

          // Check if job is less than 24 hours old
          if (hours < 24) {
            document.getElementById("resumeBanner").classList.add("active");
            document.getElementById("resumeJobId").textContent = jobId;
            document.getElementById("resumeJobUrl").textContent =
              jobUrl || "N/A";

            const startDate = new Date(parseInt(jobStartTime));
            document.getElementById("resumeJobTime").textContent =
              startDate.toLocaleString() + ` (${hours}h ago)`;
          } else {
            // Job expired
            clearJobFromStorage();
          }
        }
      }

      function resumeJob() {
        const jobId = localStorage.getItem("currentJobId");
        if (jobId) {
          document.getElementById("resumeBanner").classList.remove("active");
          connectToJobStream(jobId);
        }
      }

      function clearJob() {
        clearJobFromStorage();
        document.getElementById("resumeBanner").classList.remove("active");
      }

      function clearJobFromStorage() {
        localStorage.removeItem("currentJobId");
        localStorage.removeItem("jobUrl");
        localStorage.removeItem("jobStartTime");
      }

      function formatTime() {
        const now = new Date();
        return now.toLocaleTimeString("en-US", {
          hour12: false,
          hour: "2-digit",
          minute: "2-digit",
          second: "2-digit",
        });
      }

      function switchTab(tabName) {
        // Update tab buttons
        document.querySelectorAll(".tab").forEach((tab) => {
          tab.classList.remove("active");
        });
        event.target.classList.add("active");

        // Update tab content
        document.querySelectorAll(".tab-content").forEach((content) => {
          content.classList.remove("active");
        });
        document.getElementById(tabName + "Tab").classList.add("active");
      }

      function addEvent(event) {
        const eventsList = document.getElementById("eventsList");
        const eventItem = document.createElement("div");

        let eventClass = event.event || "update";
        let message = event.message || "Processing...";
        let additionalContent = "";

        // Add URL for reading events
        if (event.event === "reading" && event.url) {
          additionalContent = `<div class="event-url">${event.url}</div>`;
        }

        eventItem.className = `event-item ${eventClass}`;
        eventItem.innerHTML = `
                <div class="event-time">${formatTime()}</div>
                <div class="event-message">${message}</div>
                ${additionalContent}
            `;

        eventsList.appendChild(eventItem);
        eventsList.scrollTop = eventsList.scrollHeight;
      }

      async function startScraping() {
        const urlInput = document.getElementById("urlInput");
        const url = urlInput.value.trim();

        if (!url) {
          alert("Please enter a valid URL");
          return;
        }

        const scrapeBtn = document.getElementById("scrapeBtn");
        const scrapeStreamBtn = document.getElementById("scrapeStreamBtn");
        scrapeBtn.disabled = true;
        scrapeStreamBtn.disabled = true;
        scrapeBtn.textContent = "Submitting job...";

        try {
          // Submit async job
          const response = await fetch("http://localhost:8000/scrape/async", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ source_url: url }),
          });

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          const data = await response.json();
          const jobId = data.job_id;

          // Store job info in localStorage
          localStorage.setItem("currentJobId", jobId);
          localStorage.setItem("jobUrl", url);
          localStorage.setItem("jobStartTime", Date.now().toString());

          // Hide resume banner if visible
          document.getElementById("resumeBanner").classList.remove("active");

          // Connect to job stream
          connectToJobStream(jobId);
        } catch (error) {
          console.error("Error submitting job:", error);
          alert(`Failed to submit job: ${error.message}`);
          scrapeBtn.disabled = false;
          scrapeStreamBtn.disabled = false;
          scrapeBtn.textContent = "Start Async Job";
        }
      }

      async function startScrapingSSE() {
        const urlInput = document.getElementById("urlInput");
        const url = urlInput.value.trim();

        if (!url) {
          alert("Please enter a valid URL");
          return;
        }

        const scrapeBtn = document.getElementById("scrapeBtn");
        const scrapeStreamBtn = document.getElementById("scrapeStreamBtn");
        const statusSection = document.getElementById("statusSection");
        const resultSection = document.getElementById("resultSection");
        const eventsList = document.getElementById("eventsList");
        const resultContent = document.getElementById("resultContent");
        const jobInfo = document.getElementById("jobInfo");

        scrapeBtn.disabled = true;
        scrapeStreamBtn.disabled = true;
        scrapeStreamBtn.textContent = "Streaming...";

        // Update UI
        statusSection.classList.add("active");
        resultSection.classList.remove("active");
        eventsList.innerHTML = "";
        resultContent.textContent = "";

        // Hide job info for SSE mode (no job_id)
        jobInfo.style.display = "none";

        // Close any existing connection
        if (eventSource) {
          eventSource.close();
        }

        try {
          // Connect to SSE stream endpoint
          const streamUrl = `http://localhost:8000/scrape/stream`;

          const response = await fetch(streamUrl, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ source_url: url }),
          });

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          const reader = response.body.getReader();
          const decoder = new TextDecoder();
          let buffer = "";

          while (true) {
            const { done, value } = await reader.read();

            if (done) {
              console.log("Stream complete");
              break;
            }

            // Decode chunk and add to buffer
            buffer += decoder.decode(value, { stream: true });

            // Process complete SSE messages
            const lines = buffer.split("\n");
            buffer = lines.pop(); // Keep incomplete line in buffer

            for (const line of lines) {
              if (line.startsWith("data: ")) {
                try {
                  const eventData = JSON.parse(line.substring(6));
                  console.log("SSE Event received:", eventData);

                  addEvent(eventData);

                  // Handle completion event
                  if (eventData.event === "complete") {
                    resultContent.textContent = JSON.stringify(
                      eventData.data,
                      null,
                      2
                    );

                    // Store and render the result data
                    currentResultData = eventData.data;
                    renderProductView(currentResultData);

                    // Copy events to the trail tab
                    const eventsTrail = document.getElementById("eventsTrail");
                    eventsTrail.innerHTML = eventsList.innerHTML;

                    // Hide status section and show result with tabs
                    statusSection.classList.remove("active");
                    resultSection.classList.add("active");

                    // Clean up
                    scrapeBtn.disabled = false;
                    scrapeStreamBtn.disabled = false;
                    scrapeStreamBtn.textContent = "Start SSE Stream";
                  }

                  // Handle error event
                  if (eventData.event === "error") {
                    // Copy events to the trail tab
                    const eventsTrail = document.getElementById("eventsTrail");
                    eventsTrail.innerHTML = eventsList.innerHTML;

                    // Show error in result tab
                    resultContent.textContent = `Error: ${
                      eventData.error || eventData.message
                    }`;

                    statusSection.classList.remove("active");
                    resultSection.classList.add("active");

                    // Clean up
                    scrapeBtn.disabled = false;
                    scrapeStreamBtn.disabled = false;
                    scrapeStreamBtn.textContent = "Start SSE Stream";
                  }
                } catch (e) {
                  console.error("Failed to parse SSE event:", e);
                }
              }
            }
          }
        } catch (error) {
          console.error("Error with SSE stream:", error);

          addEvent({
            event: "error",
            message: `Stream error: ${error.message}`,
          });

          // Copy events to trail
          const eventsTrail = document.getElementById("eventsTrail");
          eventsTrail.innerHTML = eventsList.innerHTML;

          statusSection.classList.remove("active");
          resultSection.classList.add("active");

          scrapeBtn.disabled = false;
          scrapeStreamBtn.disabled = false;
          scrapeStreamBtn.textContent = "Start SSE Stream";
        }
      }

      function connectToJobStream(jobId) {
        const scrapeBtn = document.getElementById("scrapeBtn");
        const scrapeStreamBtn = document.getElementById("scrapeStreamBtn");
        const statusSection = document.getElementById("statusSection");
        const resultSection = document.getElementById("resultSection");
        const eventsList = document.getElementById("eventsList");
        const resultContent = document.getElementById("resultContent");
        const jobInfo = document.getElementById("jobInfo");

        // Update UI
        scrapeBtn.disabled = true;
        scrapeStreamBtn.disabled = true;
        scrapeBtn.textContent = "Job in progress...";
        statusSection.classList.add("active");
        resultSection.classList.remove("active");
        eventsList.innerHTML = "";
        resultContent.textContent = "";

        // Show job info
        jobInfo.style.display = "block";
        document.getElementById("currentJobId").textContent = jobId;
        document.getElementById("currentJobStatus").textContent =
          "connecting...";

        currentJobId = jobId;

        // Close any existing connection
        if (eventSource) {
          eventSource.close();
        }

        // Connect to SSE stream
        const streamUrl = `http://localhost:8000/jobs/${jobId}/stream`;
        eventSource = new EventSource(streamUrl);

        eventSource.onopen = function () {
          console.log("SSE connection established");
          document.getElementById("currentJobStatus").textContent = "connected";
        };

        eventSource.onmessage = function (e) {
          try {
            const eventData = JSON.parse(e.data);
            console.log("Event received:", eventData);

            addEvent(eventData);

            // Update status
            if (eventData.event === "start") {
              document.getElementById("currentJobStatus").textContent =
                "processing";
            }

            // Handle completion event
            if (eventData.event === "complete") {
              document.getElementById("currentJobStatus").textContent =
                "completed";
              resultContent.textContent = JSON.stringify(
                eventData.data,
                null,
                2
              );

              // Store and render the result data
              currentResultData = eventData.data;
              renderProductView(currentResultData);

              // Copy events to the trail tab
              const eventsTrail = document.getElementById("eventsTrail");
              eventsTrail.innerHTML = eventsList.innerHTML;

              // Hide status section and show result with tabs
              statusSection.classList.remove("active");
              resultSection.classList.add("active");

              // Clean up
              eventSource.close();
              clearJobFromStorage();
              scrapeBtn.disabled = false;
              scrapeStreamBtn.disabled = false;
              scrapeBtn.textContent = "Start Async Job";
            }

            // Handle error event
            if (eventData.event === "error") {
              document.getElementById("currentJobStatus").textContent =
                "failed";

              // Copy events to the trail tab
              const eventsTrail = document.getElementById("eventsTrail");
              eventsTrail.innerHTML = eventsList.innerHTML;

              // Show error in result tab
              resultContent.textContent = `Error: ${
                eventData.error || eventData.message
              }`;

              statusSection.classList.remove("active");
              resultSection.classList.add("active");

              // Clean up
              eventSource.close();
              clearJobFromStorage();
              scrapeBtn.disabled = false;
              scrapeStreamBtn.disabled = false;
              scrapeBtn.textContent = "Start Async Job";
            }
          } catch (e) {
            console.error("Failed to parse event:", e);
          }
        };

        eventSource.onerror = function (error) {
          console.error("SSE error:", error);
          document.getElementById("currentJobStatus").textContent =
            "connection error";

          addEvent({
            event: "error",
            message:
              "Connection lost. Job may still be processing. Try refreshing to resume.",
          });

          // Don't clear localStorage - allow resume
          scrapeBtn.disabled = false;
          scrapeStreamBtn.disabled = false;
          scrapeBtn.textContent = "Start Async Job";
          eventSource.close();
        };
      }

      // Allow Enter key to submit
      document
        .getElementById("urlInput")
        .addEventListener("keypress", function (e) {
          if (e.key === "Enter") {
            startScraping();
          }
        });
    </script>
  </body>
</html>
